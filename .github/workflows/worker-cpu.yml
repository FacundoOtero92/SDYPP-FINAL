# .github/workflows/worker-cpu.yml
name: worker-cpu CI/CD

on:
  push:
    paths:
      - "apps/worker-cpu/**"
      - ".github/workflows/worker-cpu.yml"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push image
        run: |
          set -euo pipefail
          IMAGE="docker.io/${{ secrets.DOCKER_USERNAME }}/worker-cpu"
          docker build \
            -f apps/worker-cpu/Dockerfile.dockerfile \
            -t "$IMAGE:${{ github.sha }}" \
            -t "$IMAGE:latest" \
            apps/worker-cpu
          docker push "$IMAGE:${{ github.sha }}"
          docker push "$IMAGE:latest"

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e
            IMAGE="docker.io/${{ secrets.DOCKER_USERNAME }}/worker-cpu:latest"
            sudo docker pull "$IMAGE"
            sudo docker rm -f worker-cpu || true
            sudo docker run -d --name worker-cpu --restart unless-stopped \
              --env-file /opt/worker-cpu/.env \
              "$IMAGE"
            sudo docker ps --filter "name=worker-cpu"
